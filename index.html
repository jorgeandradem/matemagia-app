<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mate Magia</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="MateMagiaApp_Ico_Lego.png">
    <link rel="apple-touch-icon" href="MateMagiaApp_Ico_Lego.png">
    <meta name="theme-color" content="#FFC107">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <style>
        :root {
            --primary: #FFC107; --secondary: #4CAF50; --accent: #2196F3;
            --danger: #FF5252; --text: #37474F; --bg: #F0F4F8; --radius: 20px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: 'Nunito', sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; height: 100dvh; overflow: hidden; color: var(--text); }
        #app { width: 100%; max-width: 480px; height: 100%; background: #fff; display: flex; flex-direction: column; position: relative; }
        .screen { display: none; flex-direction: column; height: 100%; padding: 20px; animation: fade 0.3s; overflow-y: auto; }
        .screen.active { display: flex; }
        @keyframes fade { from {opacity:0;} to {opacity:1;} }
        .flex { flex-grow: 1; }
        .center { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .row { display: flex; gap: 10px; width: 100%; }
        h1 { font-family: 'Quicksand', sans-serif; color: var(--accent); margin: 10px 0; }
        .logo { width: 140px; margin: 20px auto; display: block; }
        .btn {
            background: var(--accent); color: white; border: none; padding: 16px; border-radius: 16px; width: 100%;
            font-size: 1.2rem; font-weight: 800; cursor: pointer; box-shadow: 0 4px 0 #1976D2; margin-bottom: 12px;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-green { background: var(--secondary); box-shadow: 0 4px 0 #388E3C; }
        .btn-red { background: var(--danger); box-shadow: 0 4px 0 #D32F2F; }
        .btn-outline { background: transparent; border: 2px solid #ccc; color: #888; box-shadow: none; }
        input { padding: 15px; font-size: 1.3rem; text-align: center; width: 100%; border: 2px solid #ddd; border-radius: 16px; outline: none; margin-bottom: 20px; }
        /* DASHBOARD */
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #fff; border-bottom: 1px solid #eee; margin-bottom: 10px; }
        .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .menu-item { background: #fff; border: 2px solid #eee; border-radius: 16px; padding: 20px; text-align: center; font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 #eee; }
        .menu-item:active { transform: translateY(4px); box-shadow: none; border-color: var(--accent); }
        .random { grid-column: span 2; background: #E3F2FD; border-color: #BBDEFB; color: #1976D2; }
        /* GAME */
        .q-text { font-size: 4rem; font-weight: 900; color: var(--accent); margin: 20px 0; }
        .ans-text { font-size: 3rem; border-bottom: 4px solid #ccc; min-width: 100px; text-align: center; min-height: 60px; }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: auto; }
        .key { background: #fff; border: 2px solid #eee; border-radius: 12px; font-size: 1.8rem; font-weight: bold; padding: 15px; text-align: center; cursor: pointer; box-shadow: 0 4px 0 #eee; }
        .key:active { transform: translateY(4px); box-shadow: none; }
        .key-ok { background: var(--secondary); color: white; border-color: #388E3C; box-shadow: 0 4px 0 #388E3C; }
        /* RELAX */
        .relax-circle { width: 200px; height: 200px; background: #7E57C2; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.8rem; animation: breathe 4s infinite ease-in-out; margin: 40px auto; }
        @keyframes breathe { 0%,100%{transform:scale(1);} 50%{transform:scale(1.2);} }
    </style>
</head>
<body>

<div id="app">
    <div id="scr-home" class="screen active center">
        <img src="MateMagiaApp_Ico_Lego.png" class="logo">
        <h1>Mate Magia</h1>
        <p>¬°Aprende las tablas jugando!</p>
        <div class="flex"></div>
        <button class="btn btn-green" onclick="App.start()">¬°ENTRAR A CLASE!</button>
        <button class="btn btn-outline" onclick="App.nav('scr-help')">¬øC√ìMO JUGAR?</button>
    </div>

    <div id="scr-login" class="screen center">
        <h2>¬øC√≥mo te llamas?</h2>
        <input type="text" id="input-name" placeholder="Tu nombre" maxlength="12">
        <button class="btn btn-green" onclick="User.save()">GUARDAR Y ENTRAR</button>
        <button class="btn btn-outline" onclick="App.nav('scr-home')">VOLVER</button>
    </div>

    <div id="scr-dash" class="screen">
        <div class="top-bar">
            <div><b id="dash-name" style="font-size:1.2rem"></b><br><small style="color:#888">Puntos: <span id="dash-score">0</span></small></div>
            <button class="btn-outline" style="width:auto; padding:5px 10px; margin:0;" onclick="User.changeName()">‚úé</button>
        </div>
        <h3 style="text-align:center; color:var(--accent)">Elige tu misi√≥n:</h3>
        <div class="grid-menu flex" style="overflow-y:auto; padding-bottom:10px;">
            <div class="menu-item random" onclick="Game.init('random')">üé≤ QUIZ SORPRESA</div>
            <div id="tables-grid" style="display:contents"></div>
        </div>
        <div class="row">
            <button class="btn btn-outline" onclick="App.nav('scr-review')">üìò REPASAR</button>
            <button class="btn btn-red" onclick="App.nav('scr-home')">SALIR</button>
        </div>
    </div>

    <div id="scr-game" class="screen center">
        <div class="top-bar" style="width:100%">
            <button class="btn-outline" style="width:auto; padding:5px 10px; margin:0" onclick="Game.exit()">‚úñ</button>
            <span style="font-weight:bold; color:var(--accent)">‚≠ê <span id="game-pts">0</span></span>
        </div>
        <div class="flex center">
            <div id="q-txt" class="q-text">2 x 2</div>
            <div id="ans-txt" class="ans-text"></div>
        </div>
        <div class="numpad" style="width:100%">
            <div class="key" onclick="Game.in(1)">1</div><div class="key" onclick="Game.in(2)">2</div><div class="key" onclick="Game.in(3)">3</div>
            <div class="key" onclick="Game.in(4)">4</div><div class="key" onclick="Game.in(5)">5</div><div class="key" onclick="Game.in(6)">6</div>
            <div class="key" onclick="Game.in(7)">7</div><div class="key" onclick="Game.in(8)">8</div><div class="key" onclick="Game.in(9)">9</div>
            <div class="key" onclick="Game.del()">‚å´</div><div class="key" onclick="Game.in(0)">0</div><div class="key key-ok" onclick="Game.check()">OK</div>
        </div>
        <button class="btn btn-outline" style="margin-top:15px" onclick="Audio.relax()">‚òï DESCANSO</button>
    </div>

    <div id="scr-review" class="screen">
        <div class="top-bar"><h2>Estudiar</h2><button class="btn-outline" style="width:auto; padding:5px 10px; margin:0" onclick="App.nav('scr-dash')">‚úñ</button></div>
        <div class="grid-menu" id="review-grid"></div>
    </div>

    <div id="scr-study" class="screen">
        <div class="top-bar"><h2 id="st-title">Tabla</h2><button class="btn-outline" style="width:auto; padding:5px 10px; margin:0" onclick="App.nav('scr-review')">‚úñ</button></div>
        <div id="st-content" class="flex" style="overflow-y:auto; font-size:1.5rem; text-align:center; line-height:2;"></div>
    </div>

    <div id="scr-relax" class="screen center" style="background:#E1F5FE">
        <h2 style="color:#7E57C2">Zona de Relax</h2>
        <div class="relax-circle">Respira</div>
        <button class="btn" style="background:#7E57C2; color:white; width:auto; margin-top:40px" onclick="Audio.stopRelax()">VOLVER</button>
    </div>

    <div id="scr-help" class="screen">
        <h2>Instrucciones</h2>
        <p>1. Gana monedas respondiendo bien.<br>2. Usa el bot√≥n Descanso si te cansas.</p>
        <button class="btn" onclick="App.nav('scr-home')">ENTENDIDO</button>
    </div>
</div>

<script>
    const Audio={ctx:null, tmr:null,
        init:()=>{if(!Audio.ctx) Audio.ctx=new (window.AudioContext||window.webkitAudioContext)(); if(Audio.ctx.state==='suspended')Audio.ctx.resume();},
        play:(f,t,d,v=0.1)=>{if(!Audio.ctx)return; let o=Audio.ctx.createOscillator(),g=Audio.ctx.createGain(); o.type=t; o.frequency.value=f; g.gain.setValueAtTime(0,Audio.ctx.currentTime); g.gain.linearRampToValueAtTime(v,Audio.ctx.currentTime+0.05); g.gain.exponentialRampToValueAtTime(0.001,Audio.ctx.currentTime+d); o.connect(g); g.connect(Audio.ctx.destination); o.start(); o.stop(Audio.ctx.currentTime+d);},
        click:()=>Audio.play(400,'triangle',0.1), good:()=>{Audio.play(600,'sine',0.1);setTimeout(()=>Audio.play(900,'sine',0.2),100);}, bad:()=>Audio.play(150,'sawtooth',0.3),
        speak:(t)=>{window.speechSynthesis.cancel(); let u=new SpeechSynthesisUtterance(t); u.lang='es-ES'; window.speechSynthesis.speak(u);},
        relax:()=>{App.nav('scr-relax'); const n=[196,220,246,293,329]; Audio.tmr=setInterval(()=>Audio.play(n[Math.floor(Math.random()*n.length)],'sine',3,0.03),2000);},
        stopRelax:()=>{clearInterval(Audio.tmr); App.nav('scr-game');}
    };

    let DB = JSON.parse(localStorage.getItem('mm_simple_v1')) || { name:'', score:0 };

    const App={
        nav:(id)=>{Audio.click(); document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active');},
        start:()=>{Audio.init(); if(!DB.name) App.nav('scr-login'); else User.load();},
        save:()=>{localStorage.setItem('mm_simple_v1', JSON.stringify(DB));}
    };

    const User={
        save:()=>{let n=document.getElementById('input-name').value.trim(); if(!n)return alert('Escribe nombre'); DB.name=n; App.save(); User.load();},
        load:()=>{
            document.getElementById('dash-name').innerText=DB.name; document.getElementById('dash-score').innerText=DB.score;
            let tg='', rg=''; for(let i=1;i<=10;i++){ tg+=`<div class="menu-item" onclick="Game.init(${i})">Tabla ${i}</div>`; rg+=`<div class="menu-item" onclick="Study.open(${i})">Tabla ${i}</div>`; }
            document.getElementById('tables-grid').innerHTML=tg; document.getElementById('review-grid').innerHTML=rg;
            Audio.speak('Hola '+DB.name); App.nav('scr-dash');
        },
        changeName:()=>{DB.name=''; App.nav('scr-login');}
    };

    const Game={
        t:1, q:0, sc:0, max:10, n1:0, n2:0, ans:0,
        init:(t)=>{Game.t=t; Game.sc=0; Game.q=0; document.getElementById('game-pts').innerText=0; Game.next(); App.nav('scr-game');},
        next:()=>{
            document.getElementById('ans-txt').innerText=''; if(Game.q>=Game.max){ alert(`Fin! Aciertos: ${Game.sc}/${Game.max}`); return User.load(); }
            Game.q++; let n1=(Game.t==='random')?Math.ceil(Math.random()*10):Game.t, n2=Math.ceil(Math.random()*10);
            Game.n1=n1; Game.n2=n2; Game.ans=n1*n2;
            document.getElementById('q-txt').innerText=`${n1} x ${n2}`; Audio.speak(`${n1} por ${n2}`);
        },
        in:(n)=>{Audio.click(); let el=document.getElementById('ans-txt'); if(el.innerText.length<3)el.innerText+=n;},
        del:()=>{Audio.click(); let el=document.getElementById('ans-txt'); el.innerText=el.innerText.slice(0,-1);},
        check:()=>{
            let v=parseInt(document.getElementById('ans-txt').innerText); if(isNaN(v))return;
            if(v===Game.ans){ Audio.good(); Game.sc++; DB.score++; App.save(); Game.next(); }
            else{ Audio.bad(); Audio.speak('No. Es '+Game.ans); alert(`Era ${Game.ans}`); Game.next(); }
            document.getElementById('game-pts').innerText=Game.sc;
        },
        exit:()=>{if(confirm('¬øSalir?')) User.load();}
    };

    const Study={
        open:(t)=>{
            document.getElementById('st-title').innerText='Tabla del '+t; let h='';
            for(let i=1;i<=10;i++) h+=`<div>${t} x ${i} = <b>${t*i}</b></div>`;
            document.getElementById('st-content').innerHTML=h; App.nav('scr-study');
        }
    };
</script>
</body>
</html>